<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OGAAC · Operador</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background:#f6f6f7; color:#111; }
    header { padding: 14px 16px; background:#111; color:#fff; position: sticky; top:0; }
    header .sub { opacity:.8; font-size: 12px; margin-top: 4px; }
    .wrap { padding: 14px 16px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .top { display:flex; align-items:center; justify-content:space-between; gap: 8px; }
    .title { font-weight: 700; }
    .muted { color:#666; font-size: 12px; }
    .badges { margin-top: 10px; display:flex; flex-wrap: wrap; gap: 6px; }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #ccc; background:#f2f2f2; }
    .ok { background:#e7f7ed; border-color:#7ad39a; }
    .warn { background:#fff6e5; border-color:#f0c36d; }
    .err { background:#fde8e8; border-color:#f19a9a; }
    .row { margin-top: 8px; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .toolbar { display:flex; gap:8px; margin: 10px 0 14px; flex-wrap: wrap; }
    button { cursor:pointer; border:1px solid #ddd; background:#fff; border-radius:10px; padding:8px 10px; }
    input { border:1px solid #ddd; border-radius:10px; padding:8px 10px; min-width: 240px; }
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <div>
      <div style="font-size:16px;font-weight:800;">OGAAC · Modo Operador</div>
      <div class="sub" id="hdr-sub">Cargando…</div>
    </div>
    <div class="muted mono" id="hdr-health"></div>
  </div>
</header>

<div class="wrap">
  <div class="toolbar">
    <button id="btn-refresh">Refrescar lista</button>
    <button id="btn-pause">Pausar polling</button>
    <input id="filter" placeholder="Filtrar (ej: suipacha, sala10, libertad...)" />
  </div>

  <div id="grid" class="grid"></div>
</div>

<script>
const POLL_MS = 2000;
let paused = false;
let allSalas = [];
const timers = new Map();

async function apiGet(url) {
  const r = await fetch(url, { credentials: "include" });
  const j = await r.json().catch(() => ({}));
  if (!r.ok || j.ok === false) throw j;
  return j;
}

function badge(text, cls="") {
  const el = document.createElement("span");
  el.className = "badge " + cls;
  el.textContent = text;
  return el;
}

function mkCard(sede, sala, label) {
  const card = document.createElement("div");
  card.className = "card";
  card.dataset.sede = sede;
  card.dataset.sala = sala;

  const top = document.createElement("div");
  top.className = "top";

  const left = document.createElement("div");
  const t = document.createElement("div");
  t.className = "title";
  t.textContent = (label ? label + " · " : "") + sede + " / " + sala;
  const sub = document.createElement("div");
  sub.className = "muted mono";
  sub.textContent = `/api/obs/${sede}/${sala}/summary`;
  left.appendChild(t);
  left.appendChild(sub);

  const right = document.createElement("div");
  right.className = "muted mono";
  right.textContent = "…";

  top.appendChild(left);
  top.appendChild(right);

  const badges = document.createElement("div");
  badges.className = "badges";

  const row1 = document.createElement("div");
  row1.className = "row mono";
  const row2 = document.createElement("div");
  row2.className = "row mono";

  card.appendChild(top);
  card.appendChild(badges);
  card.appendChild(row1);
  card.appendChild(row2);

  return { card, topRight: right, badges, row1, row2 };
}

function renderList(list) {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  timers.forEach((id) => clearInterval(id));
  timers.clear();

  list.forEach(({ sede, sala, label }) => {
    const ui = mkCard(sede, sala, label);
    grid.appendChild(ui.card);

    const tick = async () => {
      if (paused) return;
      try {
        const data = await apiGet(`/api/obs/${encodeURIComponent(sede)}/${encodeURIComponent(sala)}/summary`);
        ui.topRight.textContent = data.traceId || "";
        ui.badges.innerHTML = "";

        const streamOn = !!data.stream?.outputActive;
        const recOn = !!data.record?.outputActive;
        const op = data.state?.state || "unknown";

        ui.badges.appendChild(badge("STREAM: " + (streamOn ? "ON" : "OFF"), streamOn ? "ok" : ""));
        ui.badges.appendChild(badge("RECORD: " + (recOn ? "ON" : "OFF"), recOn ? "warn" : ""));
        ui.badges.appendChild(badge("OP: " + op, (op === "error") ? "err" : (op === "recording" ? "warn" : "ok")));

        const lastOut = data.state?.lastOutputPath;
        const lastErr = data.state?.lastError;

        ui.row1.textContent = lastOut ? ("lastOutputPath=" + lastOut) : "";
        ui.row2.textContent = lastErr ? ("lastError=" + lastErr) : "";

      } catch (e) {
        ui.topRight.textContent = e.traceId || "";
        ui.badges.innerHTML = "";
        ui.badges.appendChild(badge("ERROR / SIN AUTH", "err"));
        ui.row1.textContent = e.code ? ("code=" + e.code) : "";
        ui.row2.textContent = e.message ? ("msg=" + e.message) : "";
      }
    };

    tick();
    timers.set(sede + "|" + sala, setInterval(tick, POLL_MS));
  });

  document.getElementById("hdr-sub").textContent = `Salas: ${list.length} · Poll: ${POLL_MS}ms`;
}

async function loadConfig() {
  // usamos un endpoint dinámico para pedir /config
  const sede0 = "suipacha";
  const sala0 = "sala10";
  const data = await apiGet(`/api/obs/${encodeURIComponent(sede0)}/${encodeURIComponent(sala0)}/config`);
  allSalas = data.salas || [];
  applyFilter();
}

function applyFilter() {
  const q = (document.getElementById("filter").value || "").toLowerCase().trim();
  const filtered = !q ? allSalas : allSalas.filter(x =>
    (x.sede || "").toLowerCase().includes(q) ||
    (x.sala || "").toLowerCase().includes(q) ||
    ((x.label || "") + "").toLowerCase().includes(q)
  );
  renderList(filtered);
}

async function loadHealth() {
  try {
    const h = await apiGet("/health");
    document.getElementById("hdr-health").textContent =
      `rev=${h.gitRev || "-"} · up=${h.uptimeSec || 0}s · obsPool=${h.obsPoolSize} · recOps=${h.recordOpsSize}`;
  } catch {
    document.getElementById("hdr-health").textContent = "";
  }
}

document.getElementById("btn-refresh").addEventListener("click", () => loadConfig());
document.getElementById("btn-pause").addEventListener("click", (e) => {
  paused = !paused;
  e.target.textContent = paused ? "Reanudar polling" : "Pausar polling";
});
document.getElementById("filter").addEventListener("input", applyFilter);

(async function init() {
  await loadHealth();
  await loadConfig();
  setInterval(loadHealth, 5000);
})();
</script>
</body>
</html>
