<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>OGAAC ¬∑ Operador ¬∑ Sede</title>
  
  <!-- Preload CSS para rendimiento -->
  <link rel="preconnect" href="/api">
  <link rel="stylesheet" href="/ogaac.css">
  <link rel="stylesheet" href="/css/ogaac-operador.css">
  
  <style>
    /* ========= SEDE DETALLE - ESTILO INSTITUCIONAL ========= */
    
    /* Layout principal */
    .sede-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f3f4f6;
    }
    
    /* Header institucional */
    .sede-header {
      background: linear-gradient(135deg, #4A4A4A 0%, #333333 100%);
      border-bottom: 4px solid #800020;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .sede-header-brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .sede-header-title {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }
    
    .sede-header-subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
    }
    
    .sede-header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sede-header-actions .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.15s;
      cursor: pointer;
      border: none;
    }
    
    .sede-header-actions .btn-back {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .sede-header-actions .btn-back:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .sede-header-actions .btn-logout {
      background: #800020;
      color: #fff;
    }
    
    .sede-header-actions .btn-logout:hover {
      background: #5d1622;
    }
    
    .nav-pill {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.9);
    }
    
    /* Breadcrumb */
    .sede-breadcrumb {
      padding: 14px 24px;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sede-breadcrumb a {
      color: #800020;
      text-decoration: none;
      font-weight: 500;
    }
    
    .sede-breadcrumb a:hover {
      text-decoration: underline;
    }
    
    .sede-breadcrumb .sep {
      color: #9ca3af;
    }
    
    .sede-breadcrumb .current {
      color: #1f2937;
      font-weight: 600;
    }
    
    /* Title bar con stats */
    .sede-title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }
    
    .sede-title-bar h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .sede-badge {
      font-size: 12px;
      padding: 4px 14px;
      border-radius: 999px;
      font-weight: 600;
      background: rgba(128, 0, 32, 0.1);
      color: #800020;
    }
    
    .sede-badge.live {
      background: #dcfce7;
      color: #166534;
    }
    
    .sede-stats-inline {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .sede-stats-inline .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #4b5563;
      font-weight: 500;
    }
    
    .sede-stats-inline .stat-item .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .sede-stats-inline .dot.live { background: #22c55e; }
    .sede-stats-inline .dot.recording { background: #f59e0b; }
    .sede-stats-inline .dot.idle { background: #94a3b8; }
    .sede-stats-inline .dot.off { background: #ef4444; }
    
    /* Grid de salas */
    .sede-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      padding: 0 24px 32px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }
    
    /* Cards de sala - ESTILO PREMIUM */
    .sala-card {
      background: #fff;
      border-radius: 12px;
      border-top: 4px solid #800020;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.08);
      overflow: hidden;
      transition: all 0.2s;
    }
    
    .sala-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px -5px rgba(0,0,0,0.12);
    }
    
    .sala-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 18px;
      background: #fafafa;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .sala-card-header .sala-name {
      font-weight: 700;
      font-size: 16px;
      color: #1f2937;
    }
    
    .sala-card-header .sala-status {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 999px;
      font-weight: 600;
    }
    
    .sala-status.live { background: #dcfce7; color: #166534; }
    .sala-status.recording { background: #fef3c7; color: #92400e; }
    .sala-status.idle { background: #f1f5f9; color: #475569; }
    .sala-status.off { background: #fee2e2; color: #991b1b; }
    .sala-status.unknown { background: #f3f4f6; color: #6b7280; }
    
    .sala-card-body {
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .sala-info-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #6b7280;
    }
    
    .sala-info-row .icon {
      width: 20px;
      text-align: center;
      font-size: 14px;
    }
    
    .sala-card-footer {
      padding: 14px 18px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .sala-card-footer .btn-panel {
      padding: 8px 18px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      background: linear-gradient(135deg, #800020 0%, #a01030 100%);
      color: #fff;
      transition: all 0.15s;
    }
    
    .sala-card-footer .btn-panel:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(128,0,32,0.3);
    }
    
    /* Footer */
    .sede-footer {
      margin-top: auto;
      background: #4A4A4A;
      border-top: 3px solid #800020;
      padding: 12px 24px;
      color: rgba(255,255,255,0.7);
      font-size: 12px;
      text-align: center;
    }
    
    /* Empty state */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 24px;
      background: #fff;
      border-radius: 12px;
      border: 1px dashed #d1d5db;
    }
    
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    .empty-state h3 { margin: 0 0 8px; font-size: 18px; color: #1f2937; }
    .empty-state p { margin: 0; color: #6b7280; }
    
    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sede-header { padding: 12px 16px; }
      .sede-title-bar { padding: 16px; }
      .sede-grid { padding: 0 16px 24px; gap: 16px; }
      .sede-title-bar h1 { font-size: 20px; }
    }
  </style>
</head>
<body class="sede-page">

<header class="sede-header">
  <div class="sede-header-brand">
    <div class="sede-header-title">OGAAC ¬∑ Operador</div>
    <div class="sede-header-subtitle" id="header-subtitle">Cargando sede...</div>
  </div>
  <div class="sede-header-actions">
    <a class="btn btn-back" href="/operador/sedes.html">‚Üê Volver a Sedes</a>
    <span class="nav-pill">Modo Operador</span>
    <button data-action="logout" class="btn btn-logout" title="Cerrar sesi√≥n">üö™ Salir</button>
  </div>
</header>

<nav class="sede-breadcrumb">
  <a href="/operador/sedes.html">Sedes</a>
  <span class="sep">‚Ä∫</span>
  <span class="current" id="breadcrumb-sede">...</span>
</nav>

<section class="sede-title-bar">
  <h1>
    <span id="sede-name">Cargando...</span>
    <span class="sede-badge" id="sede-badge" style="display:none"></span>
  </h1>
  <div class="sede-stats-inline" id="sede-stats">
    <div class="stat-item"><span class="dot skeleton" style="width:10px;height:10px;border-radius:50%;"></span> Cargando...</div>
  </div>
</section>

<main class="sede-grid" id="salas-grid">
  <!-- Skeleton loaders -->
  <article class="sala-card">
    <div class="sala-card-header"><span class="skeleton" style="width:100px;height:20px;display:block;border-radius:4px;"></span></div>
    <div class="sala-card-body"><div class="skeleton" style="width:100%;height:60px;border-radius:4px;"></div></div>
  </article>
  <article class="sala-card">
    <div class="sala-card-header"><span class="skeleton" style="width:100px;height:20px;display:block;border-radius:4px;"></span></div>
    <div class="sala-card-body"><div class="skeleton" style="width:100%;height:60px;border-radius:4px;"></div></div>
  </article>
</main>

<footer class="sede-footer">
  OGAAC ¬∑ Sistema de Gesti√≥n de Audiencias ¬∑ Consejo de la Magistratura
</footer>

<script>
(function() {
  "use strict";

  // Config
  const API_BASE = "/api/obs";
  const POLL_INTERVAL = 5000;

  // Detect sede from URL
  function getSedeFromPath() {
    const path = location.pathname;
    const match = path.match(/\/operador\/([a-z]+)\/?/i);
    return match ? match[1].toLowerCase() : null;
  }

  const SEDE = getSedeFromPath();

  if (!SEDE) {
    document.getElementById("salas-grid").innerHTML = 
      "<div class=\"empty-state\"><div class=\"icon\">‚ö†Ô∏è</div><h3>Sede no identificada</h3><p><a href=\"/operador/sedes.html\">Volver a sedes</a></p></div>";
    return;
  }

  // DOM refs
  const elSubtitle = document.getElementById("header-subtitle");
  const elBreadcrumb = document.getElementById("breadcrumb-sede");
  const elSedeName = document.getElementById("sede-name");
  const elSedeBadge = document.getElementById("sede-badge");
  const elSedeStats = document.getElementById("sede-stats");
  const elSalasGrid = document.getElementById("salas-grid");

  // State
  let salasConfig = [];
  let salasStatus = {};

  function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
  function buildSalaId(sede, sala) { return sede + "-" + sala; }

  // Setup UI
  function setupUI() {
    const sedeTitle = capitalize(SEDE);
    document.title = "OGAAC ¬∑ Operador ¬∑ " + sedeTitle;
    elSubtitle.textContent = "Sede " + sedeTitle;
    elBreadcrumb.textContent = sedeTitle;
    elSedeName.textContent = "Sede " + sedeTitle;
  }

  // Fetch config with timeout
  async function fetchConfig() {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 8000);
    
    try {
      const resp = await fetch(API_BASE + "/config", { 
        credentials: "include",
        signal: controller.signal 
      });
      clearTimeout(timeout);
      
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();
      
      salasConfig = (data.salas || []).filter(s => 
        s.sede && s.sede.toLowerCase() === SEDE
      );

      if (salasConfig.length === 0) {
        elSalasGrid.innerHTML = "<div class=\"empty-state\"><div class=\"icon\">üì≠</div><h3>Sin salas configuradas</h3><p>No hay salas para " + capitalize(SEDE) + "</p></div>";
        return;
      }

      renderSalas();
      startPolling();
    } catch (err) {
      clearTimeout(timeout);
      elSalasGrid.innerHTML = "<div class=\"empty-state\"><div class=\"icon\">‚ùå</div><h3>Error de conexi√≥n</h3><p><button class=\"btn btn-panel\" onclick=\"location.reload()\">Reintentar</button></p></div>";
    }
  }

  // Render salas
  function renderSalas() {
    elSalasGrid.innerHTML = salasConfig.map(cfg => {
      const salaId = buildSalaId(cfg.sede, cfg.sala);
      return "<article class=\"sala-card\" data-sala-id=\"" + salaId + "\">" +
        "<div class=\"sala-card-header\">" +
          "<span class=\"sala-name\">" + cfg.sala.toUpperCase() + "</span>" +
          "<span class=\"sala-status unknown\" data-status-badge>Verificando...</span>" +
        "</div>" +
        "<div class=\"sala-card-body\">" +
          "<div class=\"sala-info-row\"><span class=\"icon\">üé•</span> <span data-obs-status>OBS: --</span></div>" +
          "<div class=\"sala-info-row\"><span class=\"icon\">üì°</span> <span data-stream-status>Stream: --</span></div>" +
          "<div class=\"sala-info-row\"><span class=\"icon\">üé§</span> <span data-rec-status>Grabaci√≥n: --</span></div>" +
        "</div>" +
        "<div class=\"sala-card-footer\">" +
          "<a class=\"btn-panel\" href=\"/operador/" + cfg.sede + "/" + cfg.sala + "/\" target=\"_blank\">Abrir Panel</a>" +
        "</div>" +
      "</article>";
    }).join("");
  }

  // Polling
  async function pollStatus() {
    await Promise.all(salasConfig.map(async cfg => {
      const salaId = buildSalaId(cfg.sede, cfg.sala);
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 4000);
      
      try {
        const resp = await fetch(API_BASE + "/" + cfg.sede + "/" + cfg.sala + "/status", {
          credentials: "include",
          signal: controller.signal
        });
        clearTimeout(timeout);
        
        if (!resp.ok) {
          salasStatus[salaId] = { error: true, errorMsg: "HTTP " + resp.status };
          return;
        }
        
        const data = await resp.json();
        const ok = data.ok === true;
        salasStatus[salaId] = {
          ok,
          streaming: ok && data.status?.outputActive === true,
          recording: ok && data.status?.recordingActive === true
        };
      } catch (err) {
        clearTimeout(timeout);
        salasStatus[salaId] = { error: true, errorMsg: err.name === "AbortError" ? "Timeout" : "Error" };
      }
    }));
    updateUI();
  }

  function updateUI() {
    salasConfig.forEach(cfg => {
      const salaId = buildSalaId(cfg.sede, cfg.sala);
      const card = elSalasGrid.querySelector("[data-sala-id=\"" + salaId + "\"]");
      if (!card) return;

      const status = salasStatus[salaId] || {};
      const badge = card.querySelector("[data-status-badge]");
      const obsEl = card.querySelector("[data-obs-status]");
      const streamEl = card.querySelector("[data-stream-status]");
      const recEl = card.querySelector("[data-rec-status]");

      if (status.error) {
        badge.textContent = status.errorMsg || "Error";
        badge.className = "sala-status off";
        obsEl.textContent = "OBS: " + (status.errorMsg || "Error");
        return;
      }

      if (status.streaming) {
        badge.textContent = "‚óè EN VIVO";
        badge.className = "sala-status live";
      } else if (status.recording) {
        badge.textContent = "‚óè GRABANDO";
        badge.className = "sala-status recording";
      } else if (status.ok) {
        badge.textContent = "Conectado";
        badge.className = "sala-status idle";
      } else {
        badge.textContent = "Desconectado";
        badge.className = "sala-status off";
      }

      obsEl.textContent = "OBS: " + (status.ok ? "Conectado" : "Desconectado");
      streamEl.textContent = "Stream: " + (status.streaming ? "Activo" : "Inactivo");
      recEl.textContent = "Grabaci√≥n: " + (status.recording ? "Grabando" : "Inactiva");
    });

    updateSedeStats();
  }

  function updateSedeStats() {
    let live = 0, recording = 0, idle = 0, off = 0;
    salasConfig.forEach(cfg => {
      const s = salasStatus[buildSalaId(cfg.sede, cfg.sala)] || {};
      if (s.error) off++;
      else if (s.streaming) live++;
      else if (s.recording) recording++;
      else if (s.ok) idle++;
      else off++;
    });

    elSedeStats.innerHTML = 
      "<div class=\"stat-item\"><span class=\"dot live\"></span> " + live + " en vivo</div>" +
      (recording > 0 ? "<div class=\"stat-item\"><span class=\"dot recording\"></span> " + recording + " grabando</div>" : "") +
      "<div class=\"stat-item\"><span class=\"dot idle\"></span> " + idle + " espera</div>" +
      "<div class=\"stat-item\"><span class=\"dot off\"></span> " + off + " offline</div>";

    if (live > 0) {
      elSedeBadge.textContent = live + " transmitiendo";
      elSedeBadge.className = "sede-badge live";
      elSedeBadge.style.display = "";
    } else {
      elSedeBadge.style.display = "none";
    }
  }

  function startPolling() {
    pollStatus();
    setInterval(pollStatus, POLL_INTERVAL);
  }

  // Init
  setupUI();
  fetchConfig();
})();
</script>

<script src="/operador/_shared/logout.js"></script>

</body>
</html>
